'use strict';

var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ('value' in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError('Cannot call a class as a function'); } }

System.register(['aurelia-framework', 'aurelia-router', './aurelia-adal-manager'], function (exports_1) {
    var __decorate = this && this.__decorate || function (decorators, target, key, desc) {
        var c = arguments.length,
            r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
            d;
        if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
        return c > 3 && r && Object.defineProperty(target, key, r), r;
    };
    var __metadata = this && this.__metadata || function (k, v) {
        if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
    };
    var aurelia_framework_1, aurelia_router_1, aurelia_adal_manager_1;
    var AureliaAdalAuthorizeStep;
    return {
        setters: [function (aurelia_framework_1_1) {
            aurelia_framework_1 = aurelia_framework_1_1;
        }, function (aurelia_router_1_1) {
            aurelia_router_1 = aurelia_router_1_1;
        }, function (aurelia_adal_manager_1_1) {
            aurelia_adal_manager_1 = aurelia_adal_manager_1_1;
        }],
        execute: function execute() {
            var AureliaAdalAuthorizeStep = (function () {
                function AureliaAdalAuthorizeStep(aureliaAdal) {
                    _classCallCheck(this, AureliaAdalAuthorizeStep);

                    this.aureliaAdal = aureliaAdal;
                }

                _createClass(AureliaAdalAuthorizeStep, [{
                    key: 'run',
                    value: function run(routingContext, next) {
                        var _this = this;

                        var hash = window.location.hash;
                        return this.aureliaAdal.hashHandler(hash, function (url) {
                            return next.cancel(new aurelia_router_1.Redirect(url));
                        }, function () {
                            var loginRoute = '';
                            if (routingContext.getAllInstructions().some(function (i) {
                                return !!i.config.settings.requireAdalLogin;
                            })) {
                                if (!_this.aureliaAdal.isAuthenticated()) {
                                    return _this.aureliaAdal.loginHandler(routingContext.fragment, function (url) {
                                        return next.cancel(new aurelia_router_1.Redirect(url));
                                    }, function () {
                                        return next.cancel('login redirect');
                                    });
                                }
                            } else if (_this.aureliaAdal.isAuthenticated() && routingContext.getAllInstructions().some(function (i) {
                                return i.fragment == loginRoute;
                            })) {
                                var loginRedirect = '';
                                return next.cancel(new aurelia_router_1.Redirect(loginRedirect));
                            }
                            return next();
                        }, function () {
                            return next();
                        });
                    }
                }]);

                return AureliaAdalAuthorizeStep;
            })();
            AureliaAdalAuthorizeStep = __decorate([aurelia_framework_1.inject(aurelia_adal_manager_1.AureliaAdalManager), __metadata('design:paramtypes', [aurelia_adal_manager_1.AureliaAdalManager])], AureliaAdalAuthorizeStep);
            AureliaAdalAuthorizeStep = AureliaAdalAuthorizeStep;
        }
    };
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF1cmVsaWEtYWRhbC1hdXRob3JpemUtc3RlcC5qcyIsImF1cmVsaWEtYWRhbC1hdXRob3JpemUtc3RlcC50cyJdLCJuYW1lcyI6WyJBdXJlbGlhQWRhbEF1dGhvcml6ZVN0ZXAiLCJBdXJlbGlhQWRhbEF1dGhvcml6ZVN0ZXAuY29uc3RydWN0b3IiLCJBdXJlbGlhQWRhbEF1dGhvcml6ZVN0ZXAucnVuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsbUJBQW1CLEVBQUUsZ0JBQWdCLEVBQUUsd0JBQXdCLENBQUMsRUFBRSxVQUFTLFNBQVMsRUFBRTtBQUNuRyxRQUFJLFVBQVUsR0FBRyxBQUFDLElBQUksSUFBSSxJQUFJLENBQUMsVUFBVSxJQUFLLFVBQVUsVUFBVSxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFO0FBQ25GLFlBQUksQ0FBQyxHQUFHLFNBQVMsQ0FBQyxNQUFNO1lBQUUsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsTUFBTSxHQUFHLElBQUksS0FBSyxJQUFJLEdBQUcsSUFBSSxHQUFHLE1BQU0sQ0FBQyx3QkFBd0IsQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLEdBQUcsSUFBSTtZQUFFLENBQUMsQ0FBQztBQUM3SCxZQUFJLE9BQU8sT0FBTyxLQUFLLFFBQVEsSUFBSSxPQUFPLE9BQU8sQ0FBQyxRQUFRLEtBQUssVUFBVSxFQUFFLENBQUMsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLFVBQVUsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDLEtBQzFILEtBQUssSUFBSSxDQUFDLEdBQUcsVUFBVSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsR0FBRyxVQUFVLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENB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QSxDQUFDQSxDQUFDQSxRQUFRQSxJQUFJQSxVQUFVQTs2QkFBQUEsQ0FBQ0EsRUFBRUE7QUFFeEhBLG9DQUFJQSxhQUFhQSxHQUFHQSxFQUFFQSxDQUFDQTtBQUN2QkEsdUNBQU9BLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLElBQUlBLGdCQUFBQSxDQUFBQSxRQUFRQSxDQUFDQSxhQUFhQSxDQUFDQSxDQUFDQSxDQUFDQTs2QkFDakRBO0FBRURBLG1DQUFPQSxJQUFJQSxFQUFFQSxDQUFDQTt5QkFDYkEsRUFBRUEsWUFBQUE7QUFDREEsbUNBQU9BLElBQUlBLEVBQUVBLENBQUNBO3lCQUNmQSxDQUFDQSxDQUFDQTtxQkFDTkE7Ozs7Z0JBQ0ZGLENBQUFBO0FBckNELG9DQUFBLEdBQUEsVUFBQSxDQUFBLENBQUMsbUJBQUEsQ0FBQSxNQUFNLENBQUMsc0JBQUEsQ0FBQSxrQkFBa0IsQ0FBQyxFRG1EWCxVQUFVLENBQUMsbUJBQW1CLEVBQUUsQ0FBQyxzQkFBc0IsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQy9FLEVBQUUsd0JBQXdCLENBQUMsQ0NmdkM7QUFwQ1ksb0NBQXdCLEdBQUEsd0JBb0NwQyxDQUFBO1NEaUJRO0tBQ0osQ0FBQTtDQUNKLENBQUMsQ0FBQyIsImZpbGUiOiJhdXJlbGlhLWFkYWwtYXV0aG9yaXplLXN0ZXAuanMiLCJzb3VyY2VzQ29udGVudCI6WyJTeXN0ZW0ucmVnaXN0ZXIoWydhdXJlbGlhLWZyYW1ld29yaycsICdhdXJlbGlhLXJvdXRlcicsICcuL2F1cmVsaWEtYWRhbC1tYW5hZ2VyJ10sIGZ1bmN0aW9uKGV4cG9ydHNfMSkge1xuICAgIHZhciBfX2RlY29yYXRlID0gKHRoaXMgJiYgdGhpcy5fX2RlY29yYXRlKSB8fCBmdW5jdGlvbiAoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpIHtcbiAgICAgICAgdmFyIGMgPSBhcmd1bWVudHMubGVuZ3RoLCByID0gYyA8IDMgPyB0YXJnZXQgOiBkZXNjID09PSBudWxsID8gZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBrZXkpIDogZGVzYywgZDtcbiAgICAgICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSBcIm9iamVjdFwiICYmIHR5cGVvZiBSZWZsZWN0LmRlY29yYXRlID09PSBcImZ1bmN0aW9uXCIpIHIgPSBSZWZsZWN0LmRlY29yYXRlKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKTtcbiAgICAgICAgZWxzZSBmb3IgKHZhciBpID0gZGVjb3JhdG9ycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgaWYgKGQgPSBkZWNvcmF0b3JzW2ldKSByID0gKGMgPCAzID8gZChyKSA6IGMgPiAzID8gZCh0YXJnZXQsIGtleSwgcikgOiBkKHRhcmdldCwga2V5KSkgfHwgcjtcbiAgICAgICAgcmV0dXJuIGMgPiAzICYmIHIgJiYgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCByKSwgcjtcbiAgICB9O1xuICAgIHZhciBfX21ldGFkYXRhID0gKHRoaXMgJiYgdGhpcy5fX21ldGFkYXRhKSB8fCBmdW5jdGlvbiAoaywgdikge1xuICAgICAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09IFwib2JqZWN0XCIgJiYgdHlwZW9mIFJlZmxlY3QubWV0YWRhdGEgPT09IFwiZnVuY3Rpb25cIikgcmV0dXJuIFJlZmxlY3QubWV0YWRhdGEoaywgdik7XG4gICAgfTtcbiAgICB2YXIgYXVyZWxpYV9mcmFtZXdvcmtfMSwgYXVyZWxpYV9yb3V0ZXJfMSwgYXVyZWxpYV9hZGFsX21hbmFnZXJfMTtcbiAgICB2YXIgQXVyZWxpYUFkYWxBdXRob3JpemVTdGVwO1xuICAgIHJldHVybiB7XG4gICAgICAgIHNldHRlcnM6W1xuICAgICAgICAgICAgZnVuY3Rpb24gKGF1cmVsaWFfZnJhbWV3b3JrXzFfMSkge1xuICAgICAgICAgICAgICAgIGF1cmVsaWFfZnJhbWV3b3JrXzEgPSBhdXJlbGlhX2ZyYW1ld29ya18xXzE7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZnVuY3Rpb24gKGF1cmVsaWFfcm91dGVyXzFfMSkge1xuICAgICAgICAgICAgICAgIGF1cmVsaWFfcm91dGVyXzEgPSBhdXJlbGlhX3JvdXRlcl8xXzE7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZnVuY3Rpb24gKGF1cmVsaWFfYWRhbF9tYW5hZ2VyXzFfMSkge1xuICAgICAgICAgICAgICAgIGF1cmVsaWFfYWRhbF9tYW5hZ2VyXzEgPSBhdXJlbGlhX2FkYWxfbWFuYWdlcl8xXzE7XG4gICAgICAgICAgICB9XSxcbiAgICAgICAgZXhlY3V0ZTogZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICBsZXQgQXVyZWxpYUFkYWxBdXRob3JpemVTdGVwID0gY2xhc3Mge1xuICAgICAgICAgICAgICAgIGNvbnN0cnVjdG9yKGF1cmVsaWFBZGFsKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYXVyZWxpYUFkYWwgPSBhdXJlbGlhQWRhbDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcnVuKHJvdXRpbmdDb250ZXh0LCBuZXh0KSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBoYXNoID0gd2luZG93LmxvY2F0aW9uLmhhc2g7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmF1cmVsaWFBZGFsLmhhc2hIYW5kbGVyKGhhc2gsICh1cmwpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXh0LmNhbmNlbChuZXcgYXVyZWxpYV9yb3V0ZXJfMS5SZWRpcmVjdCh1cmwpKTtcbiAgICAgICAgICAgICAgICAgICAgfSwgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGxvZ2luUm91dGUgPSAnJztcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyb3V0aW5nQ29udGV4dC5nZXRBbGxJbnN0cnVjdGlvbnMoKS5zb21lKGkgPT4gISFpLmNvbmZpZy5zZXR0aW5ncy5yZXF1aXJlQWRhbExvZ2luKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5hdXJlbGlhQWRhbC5pc0F1dGhlbnRpY2F0ZWQoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5hdXJlbGlhQWRhbC5sb2dpbkhhbmRsZXIocm91dGluZ0NvbnRleHQuZnJhZ21lbnQsICh1cmwpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXh0LmNhbmNlbChuZXcgYXVyZWxpYV9yb3V0ZXJfMS5SZWRpcmVjdCh1cmwpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5leHQuY2FuY2VsKCdsb2dpbiByZWRpcmVjdCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0aGlzLmF1cmVsaWFBZGFsLmlzQXV0aGVudGljYXRlZCgpICYmIHJvdXRpbmdDb250ZXh0LmdldEFsbEluc3RydWN0aW9ucygpLnNvbWUoaSA9PiBpLmZyYWdtZW50ID09IGxvZ2luUm91dGUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGxvZ2luUmVkaXJlY3QgPSAnJztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV4dC5jYW5jZWwobmV3IGF1cmVsaWFfcm91dGVyXzEuUmVkaXJlY3QobG9naW5SZWRpcmVjdCkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICAgICAgICAgICAgICAgICAgfSwgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIEF1cmVsaWFBZGFsQXV0aG9yaXplU3RlcCA9IF9fZGVjb3JhdGUoW1xuICAgICAgICAgICAgICAgIGF1cmVsaWFfZnJhbWV3b3JrXzEuaW5qZWN0KGF1cmVsaWFfYWRhbF9tYW5hZ2VyXzEuQXVyZWxpYUFkYWxNYW5hZ2VyKSwgXG4gICAgICAgICAgICAgICAgX19tZXRhZGF0YSgnZGVzaWduOnBhcmFtdHlwZXMnLCBbYXVyZWxpYV9hZGFsX21hbmFnZXJfMS5BdXJlbGlhQWRhbE1hbmFnZXJdKVxuICAgICAgICAgICAgXSwgQXVyZWxpYUFkYWxBdXRob3JpemVTdGVwKTtcbiAgICAgICAgICAgIEF1cmVsaWFBZGFsQXV0aG9yaXplU3RlcCA9IEF1cmVsaWFBZGFsQXV0aG9yaXplU3RlcDtcbiAgICAgICAgfVxuICAgIH1cbn0pO1xuIiwiaW1wb3J0IHtpbmplY3R9IGZyb20gJ2F1cmVsaWEtZnJhbWV3b3JrJztcclxuaW1wb3J0IHtOYXZpZ2F0aW9uSW5zdHJ1Y3Rpb24sIFJlZGlyZWN0fSBmcm9tICdhdXJlbGlhLXJvdXRlcic7XHJcbmltcG9ydCB7QXVyZWxpYUFkYWxNYW5hZ2VyfSBmcm9tICcuL2F1cmVsaWEtYWRhbC1tYW5hZ2VyJztcclxuXHJcbkBpbmplY3QoQXVyZWxpYUFkYWxNYW5hZ2VyKVxyXG5leHBvcnQgY2xhc3MgQXVyZWxpYUFkYWxBdXRob3JpemVTdGVwIHtcclxuICBcclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGF1cmVsaWFBZGFsOiBBdXJlbGlhQWRhbE1hbmFnZXIpIHtcclxuICAgIFxyXG4gIH1cclxuXHJcbiAgcnVuKHJvdXRpbmdDb250ZXh0OiBOYXZpZ2F0aW9uSW5zdHJ1Y3Rpb24sIG5leHQ6IGFueSk6IHZvaWQge1xyXG4gICAgbGV0IGhhc2ggPSB3aW5kb3cubG9jYXRpb24uaGFzaDtcclxuXHJcbiAgICByZXR1cm4gdGhpcy5hdXJlbGlhQWRhbC5oYXNoSGFuZGxlcihoYXNoLCAodXJsOiBzdHJpbmcpID0+IHtcclxuICAgICAgLy8gV2FzIGNhbGxiYWNrXHJcbiAgICAgIHJldHVybiBuZXh0LmNhbmNlbChuZXcgUmVkaXJlY3QodXJsKSk7XHJcbiAgICB9LCAoKSA9PiB7XHJcbiAgICAgIC8vIFdhcyBub3QgY2FsbGJhY2tcclxuICAgICAgbGV0IGxvZ2luUm91dGUgPSAnJzsgLy8gVE9ETzogZ2V0IGxvZ2luIHVybCBmcm9tIGF1cmVsaWFBZGFsXHJcblxyXG4gICAgICBpZiAocm91dGluZ0NvbnRleHQuZ2V0QWxsSW5zdHJ1Y3Rpb25zKCkuc29tZShpID0+ICEhaS5jb25maWcuc2V0dGluZ3MucmVxdWlyZUFkYWxMb2dpbikpIHtcclxuICAgICAgICBpZiAoIXRoaXMuYXVyZWxpYUFkYWwuaXNBdXRoZW50aWNhdGVkKCkpIHtcclxuICAgICAgICAgIC8vIE5vdCBsb2dnZWQgaW4sIHJlZGlyZWN0IHRvIGxvZ2luIHJvdXRlXHJcbiAgICAgICAgICByZXR1cm4gdGhpcy5hdXJlbGlhQWRhbC5sb2dpbkhhbmRsZXIocm91dGluZ0NvbnRleHQuZnJhZ21lbnQsICh1cmw6IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gbmV4dC5jYW5jZWwobmV3IFJlZGlyZWN0KHVybCkpO1xyXG4gICAgICAgICAgfSwgKCkgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gbmV4dC5jYW5jZWwoJ2xvZ2luIHJlZGlyZWN0Jyk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSBpZiAodGhpcy5hdXJlbGlhQWRhbC5pc0F1dGhlbnRpY2F0ZWQoKSAmJiByb3V0aW5nQ29udGV4dC5nZXRBbGxJbnN0cnVjdGlvbnMoKS5zb21lKGkgPT4gaS5mcmFnbWVudCA9PSBsb2dpblJvdXRlKSkge1xyXG4gICAgICAgIC8vIExvZ2dlZCBpbiwgY3VycmVudCByb3V0ZSBpcyB0aGUgbG9naW4gcm91dGVcclxuICAgICAgICBsZXQgbG9naW5SZWRpcmVjdCA9ICcnO1xyXG4gICAgICAgIHJldHVybiBuZXh0LmNhbmNlbChuZXcgUmVkaXJlY3QobG9naW5SZWRpcmVjdCkpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICByZXR1cm4gbmV4dCgpO1xyXG4gICAgICB9LCAoKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIG5leHQoKTtcclxuICAgICAgfSk7XHJcbiAgfVxyXG59Il0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
