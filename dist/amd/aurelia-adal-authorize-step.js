"use strict";

var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var __decorate = undefined && undefined.__decorate || function (decorators, target, key, desc) {
    var c = arguments.length,
        r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
        d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = undefined && undefined.__metadata || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
define(["require", "exports", 'aurelia-framework', 'aurelia-router', './aurelia-adal-manager'], function (require, exports, aurelia_framework_1, aurelia_router_1, aurelia_adal_manager_1) {
    var AureliaAdalAuthorizeStep = (function () {
        function AureliaAdalAuthorizeStep(aureliaAdal) {
            _classCallCheck(this, AureliaAdalAuthorizeStep);

            this.aureliaAdal = aureliaAdal;
        }

        _createClass(AureliaAdalAuthorizeStep, [{
            key: "run",
            value: function run(routingContext, next) {
                var _this = this;

                var hash = window.location.hash;
                return this.aureliaAdal.hashHandler(hash, function (url) {
                    // Was callback
                    return next.cancel(new aurelia_router_1.Redirect(url));
                }, function () {
                    // Was not callback
                    var loginRoute = ''; // TODO: get login url from aureliaAdal
                    if (routingContext.getAllInstructions().some(function (i) {
                        return !!i.config.settings.requireAdalLogin;
                    })) {
                        if (!_this.aureliaAdal.isAuthenticated()) {
                            // Not logged in, redirect to login route
                            return _this.aureliaAdal.loginHandler(routingContext.fragment, function (url) {
                                return next.cancel(new aurelia_router_1.Redirect(url));
                            }, function () {
                                return next.cancel('login redirect');
                            });
                        }
                    } else if (_this.aureliaAdal.isAuthenticated() && routingContext.getAllInstructions().some(function (i) {
                        return i.fragment == loginRoute;
                    })) {
                        // Logged in, current route is the login route
                        var loginRedirect = '';
                        return next.cancel(new aurelia_router_1.Redirect(loginRedirect));
                    }
                    return next();
                }, function () {
                    return next();
                });
            }
        }]);

        return AureliaAdalAuthorizeStep;
    })();
    AureliaAdalAuthorizeStep = __decorate([aurelia_framework_1.inject(aurelia_adal_manager_1.AureliaAdalManager), __metadata('design:paramtypes', [aurelia_adal_manager_1.AureliaAdalManager])], AureliaAdalAuthorizeStep);
    exports.AureliaAdalAuthorizeStep = AureliaAdalAuthorizeStep;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF1cmVsaWEtYWRhbC1hdXRob3JpemUtc3RlcC5qcyIsImF1cmVsaWEtYWRhbC1hdXRob3JpemUtc3RlcC50cyJdLCJuYW1lcyI6WyJBdXJlbGlhQWRhbEF1dGhvcml6ZVN0ZXAiLCJBdXJlbGlhQWRhbEF1dGhvcml6ZVN0ZXAuY29uc3RydWN0b3IiLCJBdXJlbGlhQWRhbEF1dGhvcml6ZVN0ZXAucnVuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxJQUFJLFVBQVUsR0FBRyxBQUFDLGFBQVEsVUFBSyxVQUFVLElBQUssVUFBVSxVQUFVLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUU7QUFDbkYsUUFBSSxDQUFDLEdBQUcsU0FBUyxDQUFDLE1BQU07UUFBRSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxNQUFNLEdBQUcsSUFBSSxLQUFLLElBQUksR0FBRyxJQUFJLEdBQUcsTUFBTSxDQUFDLHdCQUF3QixDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsR0FBRyxJQUFJO1FBQUUsQ0FBQyxDQUFDO0FBQzdILFFBQUksT0FBTyxPQUFPLEtBQUssUUFBUSxJQUFJLE9BQU8sT0FBTyxDQUFDLFFBQVEsS0FBSyxVQUFVLEVBQUUsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsVUFBVSxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUMsS0FDMUgsS0FBSyxJQUFJLENBQUMsR0FBRyxVQUFVLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxHQUFHLFVBQVUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFN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RUFBRUEsQ0FBQ0E7aUJBQ2ZBLENBQUNBLENBQUNBO2FBQ05BOzs7O1FBQ0ZGLENBQUFBO0FBckNELDRCQUFBLEdBQUEsVUFBQSxDQUFBLENBQUMsbUJBQUEsQ0FBQSxNQUFNLENBQUMsc0JBQUEsQ0FBQSxrQkFBa0IsQ0FBQyxFRHlDbkIsVUFBVSxDQUFDLG1CQUFtQixFQUFFLENBQUMsc0JBQXNCLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUMvRSxFQUFFLHdCQUF3QixDQUFDLENDTC9CO0FBcENZLFdBQUEsQ0FBQSx3QkFBd0IsR0FBQSx3QkFvQ3BDLENBQUE7Q0RPQSxDQUFDLENBQUMiLCJmaWxlIjoiYXVyZWxpYS1hZGFsLWF1dGhvcml6ZS1zdGVwLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIF9fZGVjb3JhdGUgPSAodGhpcyAmJiB0aGlzLl9fZGVjb3JhdGUpIHx8IGZ1bmN0aW9uIChkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYykge1xuICAgIHZhciBjID0gYXJndW1lbnRzLmxlbmd0aCwgciA9IGMgPCAzID8gdGFyZ2V0IDogZGVzYyA9PT0gbnVsbCA/IGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwga2V5KSA6IGRlc2MsIGQ7XG4gICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSBcIm9iamVjdFwiICYmIHR5cGVvZiBSZWZsZWN0LmRlY29yYXRlID09PSBcImZ1bmN0aW9uXCIpIHIgPSBSZWZsZWN0LmRlY29yYXRlKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKTtcbiAgICBlbHNlIGZvciAodmFyIGkgPSBkZWNvcmF0b3JzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSBpZiAoZCA9IGRlY29yYXRvcnNbaV0pIHIgPSAoYyA8IDMgPyBkKHIpIDogYyA+IDMgPyBkKHRhcmdldCwga2V5LCByKSA6IGQodGFyZ2V0LCBrZXkpKSB8fCByO1xuICAgIHJldHVybiBjID4gMyAmJiByICYmIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgciksIHI7XG59O1xudmFyIF9fbWV0YWRhdGEgPSAodGhpcyAmJiB0aGlzLl9fbWV0YWRhdGEpIHx8IGZ1bmN0aW9uIChrLCB2KSB7XG4gICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSBcIm9iamVjdFwiICYmIHR5cGVvZiBSZWZsZWN0Lm1ldGFkYXRhID09PSBcImZ1bmN0aW9uXCIpIHJldHVybiBSZWZsZWN0Lm1ldGFkYXRhKGssIHYpO1xufTtcbmRlZmluZShbXCJyZXF1aXJlXCIsIFwiZXhwb3J0c1wiLCAnYXVyZWxpYS1mcmFtZXdvcmsnLCAnYXVyZWxpYS1yb3V0ZXInLCAnLi9hdXJlbGlhLWFkYWwtbWFuYWdlciddLCBmdW5jdGlvbiAocmVxdWlyZSwgZXhwb3J0cywgYXVyZWxpYV9mcmFtZXdvcmtfMSwgYXVyZWxpYV9yb3V0ZXJfMSwgYXVyZWxpYV9hZGFsX21hbmFnZXJfMSkge1xuICAgIGxldCBBdXJlbGlhQWRhbEF1dGhvcml6ZVN0ZXAgPSBjbGFzcyB7XG4gICAgICAgIGNvbnN0cnVjdG9yKGF1cmVsaWFBZGFsKSB7XG4gICAgICAgICAgICB0aGlzLmF1cmVsaWFBZGFsID0gYXVyZWxpYUFkYWw7XG4gICAgICAgIH1cbiAgICAgICAgcnVuKHJvdXRpbmdDb250ZXh0LCBuZXh0KSB7XG4gICAgICAgICAgICBsZXQgaGFzaCA9IHdpbmRvdy5sb2NhdGlvbi5oYXNoO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuYXVyZWxpYUFkYWwuaGFzaEhhbmRsZXIoaGFzaCwgKHVybCkgPT4ge1xuICAgICAgICAgICAgICAgIC8vIFdhcyBjYWxsYmFja1xuICAgICAgICAgICAgICAgIHJldHVybiBuZXh0LmNhbmNlbChuZXcgYXVyZWxpYV9yb3V0ZXJfMS5SZWRpcmVjdCh1cmwpKTtcbiAgICAgICAgICAgIH0sICgpID0+IHtcbiAgICAgICAgICAgICAgICAvLyBXYXMgbm90IGNhbGxiYWNrXG4gICAgICAgICAgICAgICAgbGV0IGxvZ2luUm91dGUgPSAnJzsgLy8gVE9ETzogZ2V0IGxvZ2luIHVybCBmcm9tIGF1cmVsaWFBZGFsXG4gICAgICAgICAgICAgICAgaWYgKHJvdXRpbmdDb250ZXh0LmdldEFsbEluc3RydWN0aW9ucygpLnNvbWUoaSA9PiAhIWkuY29uZmlnLnNldHRpbmdzLnJlcXVpcmVBZGFsTG9naW4pKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5hdXJlbGlhQWRhbC5pc0F1dGhlbnRpY2F0ZWQoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gTm90IGxvZ2dlZCBpbiwgcmVkaXJlY3QgdG8gbG9naW4gcm91dGVcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmF1cmVsaWFBZGFsLmxvZ2luSGFuZGxlcihyb3V0aW5nQ29udGV4dC5mcmFnbWVudCwgKHVybCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXh0LmNhbmNlbChuZXcgYXVyZWxpYV9yb3V0ZXJfMS5SZWRpcmVjdCh1cmwpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV4dC5jYW5jZWwoJ2xvZ2luIHJlZGlyZWN0Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIGlmICh0aGlzLmF1cmVsaWFBZGFsLmlzQXV0aGVudGljYXRlZCgpICYmIHJvdXRpbmdDb250ZXh0LmdldEFsbEluc3RydWN0aW9ucygpLnNvbWUoaSA9PiBpLmZyYWdtZW50ID09IGxvZ2luUm91dGUpKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIExvZ2dlZCBpbiwgY3VycmVudCByb3V0ZSBpcyB0aGUgbG9naW4gcm91dGVcbiAgICAgICAgICAgICAgICAgICAgbGV0IGxvZ2luUmVkaXJlY3QgPSAnJztcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5leHQuY2FuY2VsKG5ldyBhdXJlbGlhX3JvdXRlcl8xLlJlZGlyZWN0KGxvZ2luUmVkaXJlY3QpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICAgICAgICAgIH0sICgpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV4dCgpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9O1xuICAgIEF1cmVsaWFBZGFsQXV0aG9yaXplU3RlcCA9IF9fZGVjb3JhdGUoW1xuICAgICAgICBhdXJlbGlhX2ZyYW1ld29ya18xLmluamVjdChhdXJlbGlhX2FkYWxfbWFuYWdlcl8xLkF1cmVsaWFBZGFsTWFuYWdlciksIFxuICAgICAgICBfX21ldGFkYXRhKCdkZXNpZ246cGFyYW10eXBlcycsIFthdXJlbGlhX2FkYWxfbWFuYWdlcl8xLkF1cmVsaWFBZGFsTWFuYWdlcl0pXG4gICAgXSwgQXVyZWxpYUFkYWxBdXRob3JpemVTdGVwKTtcbiAgICBleHBvcnRzLkF1cmVsaWFBZGFsQXV0aG9yaXplU3RlcCA9IEF1cmVsaWFBZGFsQXV0aG9yaXplU3RlcDtcbn0pO1xuIiwiaW1wb3J0IHtpbmplY3R9IGZyb20gJ2F1cmVsaWEtZnJhbWV3b3JrJztcclxuaW1wb3J0IHtOYXZpZ2F0aW9uSW5zdHJ1Y3Rpb24sIFJlZGlyZWN0fSBmcm9tICdhdXJlbGlhLXJvdXRlcic7XHJcbmltcG9ydCB7QXVyZWxpYUFkYWxNYW5hZ2VyfSBmcm9tICcuL2F1cmVsaWEtYWRhbC1tYW5hZ2VyJztcclxuXHJcbkBpbmplY3QoQXVyZWxpYUFkYWxNYW5hZ2VyKVxyXG5leHBvcnQgY2xhc3MgQXVyZWxpYUFkYWxBdXRob3JpemVTdGVwIHtcclxuICBcclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGF1cmVsaWFBZGFsOiBBdXJlbGlhQWRhbE1hbmFnZXIpIHtcclxuICAgIFxyXG4gIH1cclxuXHJcbiAgcnVuKHJvdXRpbmdDb250ZXh0OiBOYXZpZ2F0aW9uSW5zdHJ1Y3Rpb24sIG5leHQ6IGFueSk6IHZvaWQge1xyXG4gICAgbGV0IGhhc2ggPSB3aW5kb3cubG9jYXRpb24uaGFzaDtcclxuXHJcbiAgICByZXR1cm4gdGhpcy5hdXJlbGlhQWRhbC5oYXNoSGFuZGxlcihoYXNoLCAodXJsOiBzdHJpbmcpID0+IHtcclxuICAgICAgLy8gV2FzIGNhbGxiYWNrXHJcbiAgICAgIHJldHVybiBuZXh0LmNhbmNlbChuZXcgUmVkaXJlY3QodXJsKSk7XHJcbiAgICB9LCAoKSA9PiB7XHJcbiAgICAgIC8vIFdhcyBub3QgY2FsbGJhY2tcclxuICAgICAgbGV0IGxvZ2luUm91dGUgPSAnJzsgLy8gVE9ETzogZ2V0IGxvZ2luIHVybCBmcm9tIGF1cmVsaWFBZGFsXHJcblxyXG4gICAgICBpZiAocm91dGluZ0NvbnRleHQuZ2V0QWxsSW5zdHJ1Y3Rpb25zKCkuc29tZShpID0+ICEhaS5jb25maWcuc2V0dGluZ3MucmVxdWlyZUFkYWxMb2dpbikpIHtcclxuICAgICAgICBpZiAoIXRoaXMuYXVyZWxpYUFkYWwuaXNBdXRoZW50aWNhdGVkKCkpIHtcclxuICAgICAgICAgIC8vIE5vdCBsb2dnZWQgaW4sIHJlZGlyZWN0IHRvIGxvZ2luIHJvdXRlXHJcbiAgICAgICAgICByZXR1cm4gdGhpcy5hdXJlbGlhQWRhbC5sb2dpbkhhbmRsZXIocm91dGluZ0NvbnRleHQuZnJhZ21lbnQsICh1cmw6IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gbmV4dC5jYW5jZWwobmV3IFJlZGlyZWN0KHVybCkpO1xyXG4gICAgICAgICAgfSwgKCkgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gbmV4dC5jYW5jZWwoJ2xvZ2luIHJlZGlyZWN0Jyk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSBpZiAodGhpcy5hdXJlbGlhQWRhbC5pc0F1dGhlbnRpY2F0ZWQoKSAmJiByb3V0aW5nQ29udGV4dC5nZXRBbGxJbnN0cnVjdGlvbnMoKS5zb21lKGkgPT4gaS5mcmFnbWVudCA9PSBsb2dpblJvdXRlKSkge1xyXG4gICAgICAgIC8vIExvZ2dlZCBpbiwgY3VycmVudCByb3V0ZSBpcyB0aGUgbG9naW4gcm91dGVcclxuICAgICAgICBsZXQgbG9naW5SZWRpcmVjdCA9ICcnO1xyXG4gICAgICAgIHJldHVybiBuZXh0LmNhbmNlbChuZXcgUmVkaXJlY3QobG9naW5SZWRpcmVjdCkpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICByZXR1cm4gbmV4dCgpO1xyXG4gICAgICB9LCAoKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIG5leHQoKTtcclxuICAgICAgfSk7XHJcbiAgfVxyXG59Il0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
